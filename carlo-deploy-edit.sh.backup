#!/bin/bash
# ========================================
# CARLO DEPLOY EDIT SCRIPT
# ========================================
# Lê, edita e salva scripts de deploy para sites Python
# Uso: ./carlo-deploy-edit.sh <domain> [--read|--write --content <content>]

set -e

# Cores para output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# Função para log
log() {
    echo -e "${BLUE}[$(date +'%Y-%m-%d %H:%M:%S')]${NC} $1" >&2
}

error() {
    echo -e "${RED}[ERRO]${NC} $1" >&2
    exit 1
}

success() {
    echo -e "${GREEN}[SUCESSO]${NC} $1" >&2
}

warning() {
    echo -e "${YELLOW}[AVISO]${NC} $1" >&2
}

# Verificar argumentos
ACTION=""
DOMAIN=""
CONFIG_CONTENT=""

while [[ $# -gt 0 ]]; do
    case $1 in
        --read)
            ACTION="read"
            shift
            ;;
        --write)
            ACTION="write"
            shift
            ;;
        --content)
            CONFIG_CONTENT="$2"
            shift 2
            ;;
        *)
            if [[ -z "$DOMAIN" ]]; then
                DOMAIN="$1"
            else
                error "Argumento desconhecido: $1"
            fi
            shift
            ;;
    esac
done

# Verificar se o domínio foi fornecido
if [[ -z "$DOMAIN" ]]; then
    error "Domínio é obrigatório"
fi

# Definir caminhos
SITE_DIR="/home/carlo/sites/$DOMAIN"
BACKUP_DIR="$SITE_DIR/backups"
DEPLOY_FILE="$SITE_DIR/deploy.sh"

# Função para criar backup
create_backup() {
    if [[ ! -f "$DEPLOY_FILE" ]]; then
        return
    fi
    
    mkdir -p "$BACKUP_DIR"
    TIMESTAMP=$(date +"%Y%m%d_%H%M%S")
    BACKUP_NAME="deploy_backup_${TIMESTAMP}.sh"
    BACKUP_PATH="$BACKUP_DIR/$BACKUP_NAME"
    
    if cp "$DEPLOY_FILE" "$BACKUP_PATH"; then
        log "Backup criado: $BACKUP_NAME" >&2
        echo "$BACKUP_PATH"
    else
        error "Falha ao criar backup"
    fi
}

# Função para validar conteúdo deploy script
validate_deploy_content() {
    local content="$1"
    local errors=0
    
    # Verificar se tem shebang
    if ! echo "$content" | grep -q "^#!/bin/bash"; then
        warning "Script deve começar com #!/bin/bash"
        ((errors++))
    fi
    
    # Verificar se tem pelo menos um comando
    if ! echo "$content" | grep -v "^#" | grep -v "^$" | grep -q .; then
        warning "Script deve conter pelo menos um comando"
        ((errors++))
    fi
    
    return $errors
}

# Função para ler arquivo deploy script
read_deploy_file() {
    if [[ ! -f "$DEPLOY_FILE" ]]; then
        warning "Arquivo deploy.sh não encontrado para $DOMAIN" >&2
        log "Localização: $SITE_DIR/deploy.sh" >&2
        echo "#!/bin/bash"
        echo "# Deploy script para $DOMAIN"
        echo "# Este script será executado quando o site for deployado"
        echo "#"
        echo "# Exemplo:"
        echo "# cd /home/carlo/sites/$DOMAIN/public"
        echo "# git pull origin main"
        echo "# pip install -r requirements.txt"
        echo "# sudo supervisorctl restart $DOMAIN"
        return
    fi
    
    if cat "$DEPLOY_FILE"; then
        log "Arquivo deploy.sh lido com sucesso para $DOMAIN" >&2
        log "Localização: $SITE_DIR/deploy.sh" >&2
    else
        error "Falha ao ler arquivo deploy.sh"
    fi
}

# Função para escrever arquivo deploy script
write_deploy_file() {
    local content="$1"
    
    # Verificar se o diretório do site existe
    if [[ ! -d "$SITE_DIR" ]]; then
        error "Diretório do site não encontrado: $SITE_DIR"
    fi
    
    # Validar conteúdo
    if ! validate_deploy_content "$content"; then
        warning "Problemas de validação encontrados no conteúdo deploy script"
    fi
    
    # Criar backup antes de alterar
    local backup_path=$(create_backup)
    
    # Escrever novo conteúdo (interpretar \n como quebras de linha)
    if echo -e "$content" > "$DEPLOY_FILE"; then
        chmod 755 "$DEPLOY_FILE"
        log "Arquivo deploy.sh salvo com sucesso para $DOMAIN" >&2
        log "Localização: $SITE_DIR/deploy.sh" >&2
        if [[ -n "$backup_path" ]]; then
            log "Backup disponível em: $backup_path" >&2
        fi
        success "Script de deploy atualizado" >&2
    else
        error "Falha ao salvar arquivo deploy.sh"
        
        # Tentar restaurar backup se existir
        if [[ -n "$backup_path" && -f "$backup_path" ]]; then
            if cp "$backup_path" "$DEPLOY_FILE"; then
                warning "Arquivo deploy.sh restaurado do backup" >&2
            else
                error "Falha ao restaurar backup"
            fi
        fi
    fi
}

# Executar ação baseada nos argumentos
case "$ACTION" in
    "read")
        log "Lendo script de deploy para $DOMAIN" >&2
        read_deploy_file
        ;;
    "write")
        if [[ -z "$CONFIG_CONTENT" ]]; then
            error "Conteúdo é obrigatório para operação --write"
        fi
        
        log "Salvando script de deploy para $DOMAIN" >&2
        write_deploy_file "$CONFIG_CONTENT"
        ;;
    *)
        error "Especifique --read ou --write"
        ;;
esac 